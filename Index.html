<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Sistem Daftar Nilai</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        body { padding: 10px; background-color: #f8f9fa; }
        .container-fluid { max-width: 1200px; }
        .header { background-color: #007bff; color: white; padding: 15px; border-radius: .3rem; margin-bottom: 20px; text-align: center; }
        .data-table-container { max-height: 60vh; overflow-y: auto; }
        .grade-table th, .grade-table td { font-size: 0.9rem; padding: 0.2rem 0.5rem; text-align: center; vertical-align: middle; }
        .grade-table input { width: 45px; height: 28px; padding: 0 5px; text-align: center; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.8rem; }
        .grade-table input:focus { border-color: #80bdff; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
        .grade-table .nama-siswa { text-align: left; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .avg-col { background-color: #e9ecef; font-weight: bold; }
        .rap-col { background-color: #d1ecf1; font-weight: bold; color: #0c5460; }
        .form-control-sm { height: calc(1.5em + .5rem + 2px); padding: .25rem .5rem; font-size: .875rem; border-radius: .2rem; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255, 255, 255, 0.8); z-index: 9999; 
            display: none; justify-content: center; align-items: center; 
            flex-direction: column;
        }
        .loading-spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sticky-header { position: sticky; top: 0; background-color: white; z-index: 10; border-bottom: 2px solid #dee2e6; }
        .table-responsive { overflow-x: auto; }
        .btn-group-sm > .btn, .btn-sm { padding: .25rem .5rem; font-size: .775rem; }
    </style>
</head>
<body>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p class="mt-3 text-primary">Memuat data...</p>
    </div>

    <div class="container-fluid">
        <div class="header" id="appHeader">
            <h4>Sistem Daftar Nilai</h4>
            <h1 id="subjectInfo">Mata Pelajaran: ... | Kelas: ...</h1>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header bg-white">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <button class="btn btn-primary btn-sm mr-2" data-toggle="modal" data-target="#settingsModal"><i class="fas fa-cog"></i> Pengaturan</button>
                        <button class="btn btn-success btn-sm" onclick="showAddStudentModal()"><i class="fas fa-user-plus"></i> Tambah Siswa</button>
                    </div>
                    <div class="col-md-6 text-right">
                        <div class="btn-group">
                            <button class="btn btn-info btn-sm" onclick="printPreview()"><i class="fas fa-print"></i> Cetak Daftar</button>
                            <button class="btn btn-info btn-sm" onclick="downloadExcel()"><i class="fas fa-file-excel"></i> Unduh Excel</button>
                            <button class="btn btn-danger btn-sm" onclick="resetAllGradesConfirm()"><i class="fas fa-trash-restore"></i> Reset Nilai</button>
                            <button class="btn btn-secondary btn-sm" onclick="loadStudents()"><i class="fas fa-sync"></i> Refresh Data</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card-body p-2">
                <div class="table-responsive data-table-container">
                    <table class="table table-bordered table-sm grade-table">
                        <thead class="sticky-header">
                            <tr class="text-center">
                                <th rowspan="2">No</th>
                                <th rowspan="2" style="min-width: 150px;">Nama Siswa</th>
                                <th rowspan="2">NIS/NISN</th>
                                <th colspan="5">Nilai Formatif (F)</th>
                                <th rowspan="2" class="avg-col">Rata² F</th>
                                <th colspan="3">Nilai Sumatif (S)</th>
                                <th rowspan="2" class="avg-col">Rata² S</th>
                                <th rowspan="2" style="min-width: 60px;">Nilai Akhir Semester (NAS)</th>
                                <th rowspan="2" class="rap-col" style="min-width: 60px;">Nilai Rapor (NR)</th>
                                <th rowspan="2" style="min-width: 80px;">Aksi</th>
                            </tr>
                            <tr class="text-center">
                                <th>F1</th>
                                <th>F2</th>
                                <th>F3</th>
                                <th>F4</th>
                                <th>F5</th>
                                <th>S1</th>
                                <th>S2</th>
                                <th>S3</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            <tr><td colspan="17" class="text-center text-muted">Memuat data siswa...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3 text-right">
                    <button class="btn btn-primary btn-sm mr-2" onclick="saveGrades('formatif')"><i class="fas fa-save"></i> Simpan Formatif</button>
                    <button class="btn btn-primary btn-sm mr-2" onclick="saveGrades('sumatif')"><i class="fas fa-save"></i> Simpan Sumatif</button>
                    <button class="btn btn-primary btn-sm" onclick="saveGrades('akhir')"><i class="fas fa-save"></i> Simpan Nilai Akhir</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="settingsModal" tabindex="-1" role="dialog" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel"><i class="fas fa-cog"></i> Pengaturan Aplikasi</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form id="settingsForm">
                        <div class="form-group"><label for="className">Nama Kelas</label><input type="text" class="form-control form-control-sm" id="className" required></div>
                        <div class="form-group"><label for="subjectName">Nama Mata Pelajaran</label><input type="text" class="form-control form-control-sm" id="subjectName" required></div>
                        <div class="form-group"><label for="schoolName">Nama Sekolah</label><input type="text" class="form-control form-control-sm" id="schoolName" required></div>
                        <div class="form-group"><label for="teacherName">Nama Guru Mapel</label><input type="text" class="form-control form-control-sm" id="teacherName"></div>
                        <div class="form-group"><label for="semester">Semester</label><input type="text" class="form-control form-control-sm" id="semester" required></div>
                        <div class="form-group"><label for="academicYear">Tahun Pelajaran</label><input type="text" class="form-control form-control-sm" id="academicYear" required></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="saveSettings()">Simpan Perubahan</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="studentModal" tabindex="-1" role="dialog" aria-labelledby="studentModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentModalLabel"><i class="fas fa-user"></i> Tambah Siswa</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <div id="addSingleStudentForm" style="display: none;">
                        <form id="singleStudentForm">
                            <input type="hidden" id="studentRowIndex">
                            <div class="form-group"><label for="studentNama">Nama Lengkap</label><input type="text" class="form-control form-control-sm" id="studentNama" required></div>
                            <div class="form-group"><label for="studentNIS">NIS</label><input type="number" class="form-control form-control-sm" id="studentNIS" required></div>
                            <div class="form-group"><label for="studentNISN">NISN</label><input type="number" class="form-control form-control-sm" id="studentNISN" required></div>
                            <div class="form-group"><label for="studentJK">Jenis Kelamin</label>
                                <select class="form-control form-control-sm" id="studentJK" required>
                                    <option value="">Pilih...</option>
                                    <option value="L">Laki-laki</option>
                                    <option value="P">Perempuan</option>
                                </select>
                            </div>
                        </form>
                        <button class="btn btn-primary btn-sm btn-block mt-3" onclick="saveStudent(false)">Simpan Siswa</button>
                    </div>

                    <div id="addMultipleStudentsForm" class="mt-3">
                        <p class="text-muted">Atau tambahkan banyak siswa sekaligus (tempelkan data dari Excel/Spreadsheet).</p>
                        <p class="text-danger">Format: **Nama, NIS, NISN, Jenis_Kelamin (L/P)**. Setiap siswa di baris baru.</p>
                        <div class="form-group">
                            <label for="multipleStudentsData">Data Siswa (Dipisahkan koma atau tab):</label>
                            <textarea class="form-control form-control-sm" id="multipleStudentsData" rows="5" placeholder="Contoh:\nBudi Santoso, 1234, 0012345678, L\nSiti Rahayu, 5678, 0098765432, P"></textarea>
                        </div>
                        <button class="btn btn-success btn-sm btn-block" onclick="addMultipleStudents()">Tambahkan Massal</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Konfirmasi Hapus</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true" class="text-white">&times;</span></button>
                </div>
                <div class="modal-body">
                    <p id="deleteConfirmText">Apakah Anda yakin ingin menghapus siswa ini?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger btn-sm" id="confirmDeleteButton">Hapus</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <script>
        // --- Global State ---
        let students = [];
        let settings = {};

        // --- Helper Functions ---

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function showAlert(message, type = 'success') {
            // Use Bootstrap Toast or custom modal for better alerts
            alert(message);
        }

        function calculateAvg(values) {
            const validValues = values.filter(v => v > 0);
            if (validValues.length === 0) return 0;
            const sum = validValues.reduce((a, b) => a + b, 0);
            return (sum / validValues.length).toFixed(1);
        }

        function calculateRapor(sumatifAvg, akhirSemester) {
            const avgS = parseFloat(sumatifAvg) || 0;
            const nas = parseFloat(akhirSemester) || 0;
            // Nilai Rapor = (Rata-rata Sumatif * 0.6) + (Nilai Akhir Semester * 0.4)
            return ((avgS * 0.6) + (nas * 0.4)).toFixed(1);
        }
        
        // --- Data Fetching & Rendering ---

        function loadInitialData() {
            showLoading();
            google.script.run
                .withSuccessHandler(response => {
                    settings = response;
                    updateHeader();
                    loadStudents(); // Panggil loadStudents setelah settings dimuat
                })
                .withFailureHandler(error => {
                    showAlert('Gagal memuat pengaturan: ' + error, 'error');
                    hideLoading();
                })
                .getClassAndSubject();
        }

        function updateHeader() {
            document.getElementById('subjectInfo').innerText = `Mata Pelajaran: ${settings.subjectName} | Kelas: ${settings.className} (${settings.academicYear})`;
            document.title = `Sistem Daftar Nilai - ${settings.className}`;
            // Isi form pengaturan
            document.getElementById('className').value = settings.className;
            document.getElementById('subjectName').value = settings.subjectName;
            document.getElementById('schoolName').value = settings.schoolName;
            document.getElementById('teacherName').value = settings.teacherName;
            document.getElementById('semester').value = settings.semester;
            document.getElementById('academicYear').value = settings.academicYear;
        }

        function loadStudents() {
            document.getElementById('studentTableBody').innerHTML = '<tr><td colspan="17" class="text-center text-primary">Mengambil data siswa terbaru...</td></tr>';
            
            google.script.run
                .withSuccessHandler(response => {
                    students = response;
                    renderStudents(students);
                    hideLoading();
                })
                .withFailureHandler(error => {
                    document.getElementById('studentTableBody').innerHTML = `<tr><td colspan="17" class="text-center text-danger">Gagal memuat data siswa: ${error}</td></tr>`;
                    showAlert('Gagal memuat data siswa: ' + error, 'error');
                    hideLoading();
                })
                .getAllStudentData();
        }

        function renderStudents(data) {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="17" class="text-center text-muted">Tidak ada data siswa. Silakan tambahkan siswa.</td></tr>';
                return;
            }

            data.forEach((student, index) => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-row-index', student.rowIndex);
                tr.innerHTML = `
                    <td class="text-center">${student.no}</td>
                    <td class="nama-siswa" title="${student.nama}">${student.nama}</td>
                    <td>${student.nis || '-'} / ${student.nisn || '-'}</td>
                    
                    <td><input type="number" min="0" max="100" class="grade-input formatif f1" value="${student.formatif.f1 || ''}" onchange="updateCalculations(${index})"></td>
                    <td><input type="number" min="0" max="100" class="grade-input formatif f2" value="${student.formatif.f2 || ''}" onchange="updateCalculations(${index})"></td>
                    <td><input type="number" min="0" max="100" class="grade-input formatif f3" value="${student.formatif.f3 || ''}" onchange="updateCalculations(${index})"></td>
                    <td><input type="number" min="0" max="100" class="grade-input formatif f4" value="${student.formatif.f4 || ''}" onchange="updateCalculations(${index})"></td>
                    <td><input type="number" min="0" max="100" class="grade-input formatif f5" value="${student.formatif.f5 || ''}" onchange="updateCalculations(${index})"></td>
                    <td class="avg-col" data-col="rataRataF">${student.formatif.rataRata ? parseFloat(student.formatif.rataRata).toFixed(1) : '0.0'}</td>
                    
                    <td><input type="number" min="0" max="100" class="grade-input sumatif s1" value="${student.sumatif.s1 || ''}" onchange="updateCalculations(${index})"></td>
                    <td><input type="number" min="0" max="100" class="grade-input sumatif s2" value="${student.sumatif.s2 || ''}" onchange="updateCalculations(${index})"></td>
                    <td><input type="number" min="0" max="100" class="grade-input sumatif s3" value="${student.sumatif.s3 || ''}" onchange="updateCalculations(${index})"></td>
                    <td class="avg-col" data-col="rataRataS">${student.sumatif.rataRata ? parseFloat(student.sumatif.rataRata).toFixed(1) : '0.0'}</td>
                    
                    <td><input type="number" min="0" max="100" class="grade-input akhir akhirSemester" value="${student.akhirSemester || ''}" onchange="updateCalculations(${index})"></td>
                    <td class="rap-col" data-col="nilaiRapor">${student.nilaiRapor ? parseFloat(student.nilaiRapor).toFixed(1) : '0.0'}</td>

                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editStudent(${index})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="confirmDelete(${student.rowIndex}, '${student.nama}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function updateCalculations(index) {
            const row = document.getElementById('studentTableBody').children[index];
            if (!row) return;

            // 1. Formatif Calculation
            const fInputs = row.querySelectorAll('.formatif');
            const fValues = Array.from(fInputs).map(input => parseFloat(input.value) || 0);
            const rataRataF = calculateAvg(fValues);
            row.querySelector('[data-col="rataRataF"]').innerText = rataRataF;

            // 2. Sumatif Calculation
            const sInputs = row.querySelectorAll('.sumatif');
            const sValues = Array.from(sInputs).map(input => parseFloat(input.value) || 0);
            const rataRataS = calculateAvg(sValues);
            row.querySelector('[data-col="rataRataS"]').innerText = rataRataS;
            
            // 3. Akhir Semester & Rapor Calculation
            const akhirSemesterInput = row.querySelector('.akhirSemester');
            const akhirSemester = parseFloat(akhirSemesterInput.value) || 0;
            const nilaiRapor = calculateRapor(rataRataS, akhirSemester);
            row.querySelector('[data-col="nilaiRapor"]').innerText = nilaiRapor;
            
            // Update the temporary students array
            students[index].formatif.f1 = fValues[0];
            students[index].formatif.f2 = fValues[1];
            students[index].formatif.f3 = fValues[2];
            students[index].formatif.f4 = fValues[3];
            students[index].formatif.f5 = fValues[4];
            students[index].formatif.rataRata = rataRataF;
            
            students[index].sumatif.s1 = sValues[0];
            students[index].sumatif.s2 = sValues[1];
            students[index].sumatif.s3 = sValues[2];
            students[index].sumatif.rataRata = rataRataS;
            
            students[index].akhirSemester = akhirSemester;
            students[index].nilaiRapor = nilaiRapor;
        }

        // --- Save Grades ---

        function saveGrades(type) {
            const dataToSave = [];
            
            students.forEach((student, index) => {
                const row = document.getElementById('studentTableBody').children[index];
                
                if (type === 'formatif') {
                    dataToSave.push({
                        formatif: {
                            f1: parseFloat(row.querySelector('.f1').value) || 0,
                            f2: parseFloat(row.querySelector('.f2').value) || 0,
                            f3: parseFloat(row.querySelector('.f3').value) || 0,
                            f4: parseFloat(row.querySelector('.f4').value) || 0,
                            f5: parseFloat(row.querySelector('.f5').value) || 0,
                        }
                    });
                } else if (type === 'sumatif') {
                    dataToSave.push({
                        sumatif: {
                            s1: parseFloat(row.querySelector('.s1').value) || 0,
                            s2: parseFloat(row.querySelector('.s2').value) || 0,
                            s3: parseFloat(row.querySelector('.s3').value) || 0,
                        }
                    });
                } else if (type === 'akhir') {
                    dataToSave.push({
                        akhirSemester: parseFloat(row.querySelector('.akhirSemester').value) || 0,
                    });
                }
            });

            showLoading();
            let funcName;
            if (type === 'formatif') funcName = 'saveFormatifData';
            else if (type === 'sumatif') funcName = 'saveSumatifData';
            else if (type === 'akhir') funcName = 'saveAkhirSemesterData';

            google.script.run
                .withSuccessHandler(response => {
                    if (response.success) {
                        showAlert(response.message);
                        loadStudents(); // Reload data to show final calculated values from server
                    } else {
                        showAlert('Gagal menyimpan: ' + response.message, 'error');
                    }
                    hideLoading();
                })
                .withFailureHandler(error => {
                    showAlert('Error server saat menyimpan: ' + error, 'error');
                    hideLoading();
                })
                [funcName](dataToSave);
        }

        // --- Student Management (Add/Edit/Delete) ---

        function showAddStudentModal() {
            $('#studentModalLabel').text('Tambah Siswa Baru');
            $('#studentRowIndex').val('');
            $('#singleStudentForm')[0].reset();
            $('#addSingleStudentForm').show();
            $('#addMultipleStudentsForm').show();
            $('#studentModal').modal('show');
        }

        function editStudent(index) {
            const student = students[index];
            $('#studentModalLabel').text(`Edit Siswa: ${student.nama}`);
            $('#studentRowIndex').val(student.rowIndex); // Use the visual/sorted rowIndex for temporary identification
            $('#studentNama').val(student.nama);
            $('#studentNIS').val(student.nis);
            $('#studentNISN').val(student.nisn);
            $('#studentJK').val(student.jk);
            
            // Hide bulk input form when editing
            $('#addMultipleStudentsForm').hide();
            $('#addSingleStudentForm').show();
            $('#studentModal').modal('show');
        }

        function saveStudent() {
            const studentData = {
                nama: $('#studentNama').val(),
                nis: $('#studentNIS').val(),
                nisn: $('#studentNISN').val(),
                jk: $('#studentJK').val(),
                rowIndex: $('#studentRowIndex').val()
            };
            
            if (!studentData.nama || !studentData.nis || !studentData.nisn || !studentData.jk) {
                showAlert('Semua field (Nama, NIS, NISN, JK) wajib diisi!', 'error');
                return;
            }

            showLoading();
            $('#studentModal').modal('hide');
            
            let funcName = studentData.rowIndex ? 'updateStudentData' : 'addNewStudent';

            google.script.run
                .withSuccessHandler(response => {
                    if (response.success) {
                        showAlert(response.message);
                        loadStudents(); 
                    } else {
                        showAlert('Gagal: ' + response.message, 'error');
                        hideLoading();
                    }
                })
                .withFailureHandler(error => {
                    showAlert('Error server saat menyimpan siswa: ' + error, 'error');
                    hideLoading();
                })
                [funcName](studentData);
        }
        
        function addMultipleStudents() {
            const rawData = $('#multipleStudentsData').val().trim();
            if (!rawData) {
                showAlert('Data siswa massal tidak boleh kosong.', 'error');
                return;
            }

            const lines = rawData.split('\n').filter(line => line.trim() !== '');
            const studentsData = [];

            try {
                lines.forEach((line, index) => {
                    // Try splitting by comma or tab, prioritizing comma
                    let parts = line.split(',').map(p => p.trim());
                    if (parts.length < 4) {
                        parts = line.split('\t').map(p => p.trim());
                    }
                    
                    if (parts.length < 4) {
                        throw new Error(`Baris ${index + 1} tidak memiliki 4 kolom yang diperlukan (Nama, NIS, NISN, JK).`);
                    }

                    const [nama, nis, nisn, jk] = parts;

                    if (!nama || !nis || !nisn || !jk || (jk.toUpperCase() !== 'L' && jk.toUpperCase() !== 'P')) {
                        throw new Error(`Baris ${index + 1}: Data tidak valid atau format JK salah (harus L atau P).`);
                    }

                    studentsData.push({
                        nama: nama,
                        nis: nis,
                        nisn: nisn,
                        jk: jk.toUpperCase()
                    });
                });
            } catch (error) {
                showAlert('Format data salah: ' + error.message, 'error');
                return;
            }

            if (studentsData.length === 0) {
                 showAlert('Tidak ada data siswa yang valid ditemukan.', 'error');
                 return;
            }

            showLoading();
            $('#studentModal').modal('hide');

            google.script.run
                .withSuccessHandler(response => {
                    if (response.success) {
                        showAlert(response.message);
                        loadStudents();
                    } else {
                        showAlert('Gagal menambahkan massal: ' + response.message, 'error');
                        hideLoading();
                    }
                })
                .withFailureHandler(error => {
                    showAlert('Error server saat menambahkan siswa massal: ' + error, 'error');
                    hideLoading();
                })
                .addMultipleStudents(studentsData);
        }

        function confirmDelete(rowIndex, studentName) {
            $('#deleteConfirmText').text(`Apakah Anda yakin ingin menghapus siswa ${studentName}? Menghapus siswa akan menghapus semua datanya.`);
            $('#confirmDeleteButton').off('click').on('click', function() {
                deleteStudent(rowIndex);
                $('#deleteConfirmModal').modal('hide');
            });
            $('#deleteConfirmModal').modal('show');
        }

        function deleteStudent(rowIndex) {
            showLoading();
            google.script.run
                .withSuccessHandler(response => {
                    if (response.success) {
                        showAlert(response.message);
                        loadStudents(); 
                    } else {
                        showAlert('Gagal menghapus: ' + response.message, 'error');
                        hideLoading();
                    }
                })
                .withFailureHandler(error => {
                    showAlert('Error server saat menghapus: ' + error, 'error');
                    hideLoading();
                })
                .deleteStudent(rowIndex);
        }
        
        // --- Settings Management ---
        
        function saveSettings() {
            const settingsData = {
                className: $('#className').val(),
                subjectName: $('#subjectName').val(),
                schoolName: $('#schoolName').val(),
                teacherName: $('#teacherName').val(),
                semester: $('#semester').val(),
                academicYear: $('#academicYear').val()
            };

            if (!settingsData.className || !settingsData.subjectName || !settingsData.academicYear) {
                showAlert('Nama Kelas, Mata Pelajaran, dan Tahun Ajaran wajib diisi!', 'error');
                return;
            }

            showLoading();
            $('#settingsModal').modal('hide');
            
            google.script.run
                .withSuccessHandler(response => {
                    if (response.success) {
                        showAlert(response.message);
                        // Reload data to get updated settings
                        loadInitialData(); 
                    } else {
                        showAlert('Gagal menyimpan pengaturan: ' + response.message, 'error');
                        hideLoading();
                    }
                })
                .withFailureHandler(error => {
                    showAlert('Error server saat menyimpan pengaturan: ' + error, 'error');
                    hideLoading();
                })
                .updateSettings(settingsData);
        }

        // --- Tools (Print & Export) ---

        function printPreview() {
            showLoading();
            google.script.run
                .withSuccessHandler(html => {
                    hideLoading();
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(html);
                    newWindow.document.close();
                })
                .withFailureHandler(error => {
                    showAlert('Gagal membuat pratinjau cetak: ' + error, 'error');
                    hideLoading();
                })
                .getPreviewHTML();
        }
        
        function downloadExcel() {
            if (students.length === 0) {
                showAlert('Belum ada data siswa!', 'error');
                return;
            }
            
            showLoading();
            
            google.script.run
                .withSuccessHandler(response => {
                    hideLoading();
                    const link = document.createElement('a');
                    // Create data URI for Excel file from base64
                    link.href = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,' + response.content;
                    link.download = response.fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showAlert('File Excel berhasil diunduh!');
                })
                .withFailureHandler(error => {
                    showAlert('Gagal mengunduh file Excel: ' + error, 'error');
                    hideLoading();
                })
                .downloadExcelAsBase64();
        }

        function resetAllGradesConfirm() {
            if (students.length === 0) {
                showAlert('Tidak ada data siswa untuk direset!', 'error');
                return;
            }
            
            $('#deleteConfirmText').text('Anda akan menghapus SEMUA nilai formatif, sumatif, dan nilai akhir semester untuk semua siswa. Tindakan ini tidak dapat dibatalkan. Lanjutkan?');
            $('#confirmDeleteButton').off('click').on('click', function() {
                resetAllGrades();
                $('#deleteConfirmModal').modal('hide');
            });
            $('#deleteConfirmModal').modal('show');
        }
        
        function resetAllGrades() {
            showLoading();
            google.script.run
                .withSuccessHandler(response => {
                    if (response.success) {
                        showAlert(response.message);
                        loadStudents(); 
                    } else {
                        showAlert('Gagal mereset: ' + response.message, 'error');
                        hideLoading();
                    }
                })<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Daftar Nilai</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* ------------------------------------- */
    /* CSS Styling (Tailwind-like classes) */
    /* ------------------------------------- */
    :root {
      --primary: #4285F4;
      --secondary: #34A853;
      --warning: #FBBC05;
      --danger: #EA4335;
      --gray-50: #F7FAFC;
      --gray-100: #EDF2F7;
      --gray-200: #E2E8F0;
      --gray-600: #4A5568;
      --gray-800: #2D3748;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--gray-50);
      color: var(--gray-800);
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 1px solid var(--gray-200);
      padding-bottom: 15px;
    }

    h1 {
      color: #333;
      margin-bottom: 5px;
      font-size: 1.8rem;
    }

    #headerSubtitle {
      color: var(--gray-600);
      font-size: 1rem;
    }

    /* Navigation */
    .nav {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      overflow-x: auto;
      padding-bottom: 5px;
    }

    .nav-btn {
      padding: 10px 15px;
      border: none;
      background-color: var(--gray-100);
      color: var(--gray-800);
      cursor: pointer;
      border-radius: 4px;
      font-size: 1rem;
      transition: all 0.2s;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .nav-btn.active {
      background-color: var(--primary);
      color: white;
    }

    /* Content */
    .content {
      display: none;
    }

    .content h2 {
      border-bottom: 2px solid var(--primary);
      padding-bottom: 10px;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    /* Table Styling */
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border: 1px solid var(--gray-200);
      border-radius: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    th,
    td {
      padding: 8px;
      text-align: center;
      border: 1px solid var(--gray-200);
      font-size: 0.875rem;
      white-space: nowrap;
    }

    th {
      background-color: var(--gray-100);
      font-weight: bold;
    }

    .nama {
      text-align: left !important;
      min-width: 200px;
    }

    /* Input & Button Styling */
    .btn-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-primary {
      background-color: var(--primary);
      color: white;
    }

    .btn-secondary {
      background-color: var(--secondary);
      color: white;
    }

    .btn-warning {
      background-color: var(--warning);
      color: var(--gray-800);
    }

    .btn-danger {
      background-color: var(--danger);
      color: white;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--gray-200);
      border-radius: 4px;
      font-size: 1rem;
      /* Style grade inputs to be smaller/centered */
      text-align: center;
      padding: 5px;
      max-width: 60px; /* Specific width for grade input cells */
    }
    
    td input[type="text"], td input[type="number"] {
        max-width: 60px;
    }

    /* Form Styling */
    .form-group {
      margin-bottom: 15px;
    }
    
    /* Settings */
    .settings-card {
        padding: 20px;
        border: 1px solid var(--gray-200);
        border-radius: 6px;
        margin-bottom: 20px;
    }
    
    .settings-card h3 {
        margin-bottom: 15px;
        font-size: 1.2rem;
        border-bottom: 1px dashed var(--gray-200);
        padding-bottom: 5px;
    }

    /* Modal Styling */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background-color: white;
      padding: 25px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    /* Alert */
    .alert-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1001;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-weight: 600;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .alert-success {
      background-color: var(--secondary);
      color: white;
    }

    .alert-error {
      background-color: var(--danger);
      color: white;
    }

    /* Loading Spinner */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1002;
    }

    .spinner {
      border: 4px solid var(--gray-200);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p>Memproses...</p>
  </div>

  <div class="alert-container" id="alertContainer"></div>

  <div class="container">
    <div class="header">
      <h1 id="headerTitle">Sistem Daftar Nilai</h1>
      <p id="headerSubtitle">Loading...</p>
    </div>

    <nav class="nav">
      <button class="nav-btn active" onclick="showTab('students')">
        <span class="material-icons">people</span>
        Data Siswa
      </button>
      <button class="nav-btn" onclick="showTab('formatif')">
        <span class="material-icons">assignment</span>
        Nilai Formatif
      </button>
      <button class="nav-btn" onclick="showTab('sumatif')">
        <span class="material-icons">assessment</span>
        Nilai Sumatif
      </button>
      <button class="nav-btn" onclick="showTab('akhir')">
        <span class="material-icons">school</span>
        Nilai Akhir
      </button>
      <button class="nav-btn" onclick="showTab('settings')">
        <span class="material-icons">settings</span>
        Pengaturan
      </button>
    </nav>

    <div id="studentsTab" class="content active">
      <h2>Data Siswa</h2>

      <div class="btn-group">
        <button class="btn btn-primary" onclick="showStudentModal('add')">
          <span class="material-icons">person_add</span>
          Tambah Siswa
        </button>
        <button class="btn btn-secondary" onclick="showBulkStudentModal()">
          <span class="material-icons">group_add</span>
          Tambah Massal
        </button>
        <button class="btn btn-warning" onclick="resetForm('students')">
          <span class="material-icons">refresh</span>
          Refresh Data
        </button>
        <button class="btn btn-primary" onclick="printPreview()">
          <span class="material-icons">print</span>
          Cetak
        </button>
        <button class="btn btn-secondary" onclick="downloadExcel()">
          <span class="material-icons">file_download</span>
          Download Excel
        </button>
      </div>

      <div class="table-container">
        <table id="studentsTable">
          <thead>
            <tr>
              <th>No</th>
              <th class="nama">Nama</th>
              <th>NIS</th>
              <th>NISN</th>
              <th>L/P</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            </tbody>
        </table>
      </div>
    </div>

    <div id="formatifTab" class="content">
      <h2>Nilai Formatif</h2>

      <div class="btn-group">
        <button class="btn btn-primary" onclick="saveGrades('formatif')">
          <span class="material-icons">save</span>
          Simpan
        </button>
        <button class="btn btn-warning" onclick="resetForm('formatif')">
          <span class="material-icons">refresh</span>
          Refresh Data
        </button>
      </div>

      <div class="table-container">
        <table id="formatifTable">
          <thead>
            <tr>
              <th rowspan="2">No</th>
              <th rowspan="2" class="nama">Nama</th>
              <th colspan="5">Formatif</th>
              <th rowspan="2">Rata-rata</th>
            </tr>
            <tr>
              <th>F1</th>
              <th>F2</th>
              <th>F3</th>
              <th>F4</th>
              <th>F5</th>
            </tr>
          </thead>
          <tbody>
            </tbody>
        </table>
      </div>
    </div>

    <div id="sumatifTab" class="content">
      <h2>Nilai Sumatif</h2>

      <div class="btn-group">
        <button class="btn btn-primary" onclick="saveGrades('sumatif')">
          <span class="material-icons">save</span>
          Simpan
        </button>
        <button class="btn btn-warning" onclick="resetForm('sumatif')">
          <span class="material-icons">refresh</span>
          Refresh Data
        </button>
      </div>

      <div class="table-container">
        <table id="sumatifTable">
          <thead>
            <tr>
              <th rowspan="2">No</th>
              <th rowspan="2" class="nama">Nama</th>
              <th colspan="3">Sumatif</th>
              <th rowspan="2">Rata-rata</th>
            </tr>
            <tr>
              <th>S1</th>
              <th>S2</th>
              <th>S3</th>
            </tr>
          </thead>
          <tbody>
            </tbody>
        </table>
      </div>
    </div>

    <div id="akhirTab" class="content">
      <h2>Nilai Akhir dan Rapor</h2>

      <div class="btn-group">
        <button class="btn btn-primary" onclick="saveGrades('akhir')">
          <span class="material-icons">save</span>
          Simpan Nilai Akhir
        </button>
        <button class="btn btn-danger" onclick="confirmResetAllGrades()">
          <span class="material-icons">delete_forever</span>
          Reset Semua Nilai
        </button>
        <button class="btn btn-warning" onclick="resetForm('akhir')">
          <span class="material-icons">refresh</span>
          Refresh Data
        </button>
      </div>

      <div class="table-container">
        <table id="akhirTable">
          <thead>
            <tr>
              <th>No</th>
              <th class="nama">Nama</th>
              <th>Rata-rata Sumatif</th>
              <th>Nilai Akhir</th>
              <th>Nilai Rapor</th>
            </tr>
          </thead>
          <tbody>
            </tbody>
        </table>
      </div>
    </div>

    <div id="settingsTab" class="content">
      <h2>Pengaturan</h2>

      <div class="settings-card">
        <h3>Informasi Kelas & Mata Pelajaran</h3>
        <form id="settingsForm">
          <div class="form-group">
            <label for="className">Nama Kelas *</label>
            <input type="text" id="className" required>
          </div>
          <div class="form-group">
            <label for="subjectName">Nama Mata Pelajaran *</label>
            <input type="text" id="subjectName" required>
          </div>
          <div class="form-group">
            <label for="schoolName">Nama Sekolah *</label>
            <input type="text" id="schoolName" required>
          </div>
          <div class="form-group">
            <label for="teacherName">Nama Guru Mapel</label>
            <input type="text" id="teacherName">
          </div>
          <div class="form-group">
            <label for="semester">Semester *</label>
            <select id="semester" required>
              <option value="Ganjil">Ganjil</option>
              <option value="Genap">Genap</option>
            </select>
          </div>
          <div class="form-group">
            <label for="academicYear">Tahun Ajaran *</label>
            <input type="text" id="academicYear" required placeholder="2024/2025">
          </div>


          <div class="btn-group">
            <button type="button" class="btn btn-primary" onclick="saveSettings()">
              <span class="material-icons">save</span>
              Simpan Pengaturan
            </button>
            <button type="button" class="btn btn-warning" onclick="resetForm('settings')">
              <span class="material-icons">refresh</span>
              Reset
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="studentModal" class="modal" onclick="if(event.target.id === 'studentModal') closeStudentModal()">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="studentModalTitle">Tambah Siswa</h3>
        <span class="material-icons close-btn" onclick="closeStudentModal()">close</span>
      </div>
      <form id="studentForm">
        <input type="hidden" id="studentRowIndex">
        <div class="form-group">
          <label for="studentName">Nama *</label>
          <input type="text" id="studentName" required style="max-width: none;">
        </div>
        <div class="form-group">
          <label for="studentNIS">NIS *</label>
          <input type="text" id="studentNIS" required style="max-width: none;">
        </div>
        <div class="form-group">
          <label for="studentNISN">NISN *</label>
          <input type="text" id="studentNISN" required style="max-width: none;">
        </div>
        <div class="form-group">
          <label for="studentGender">Jenis Kelamin *</label>
          <select id="studentGender" required style="max-width: none;">
            <option value="">Pilih Jenis Kelamin</option>
            <option value="L">Laki-laki</option>
            <option value="P">Perempuan</option>
          </select>
        </div>
      </form>
      <div class="modal-footer">
        <button class="btn btn-warning" onclick="closeStudentModal()">Batal</button>
        <button class="btn btn-primary" onclick="saveStudent()">Simpan</button>
      </div>
    </div>
  </div>

  <div id="bulkStudentModal" class="modal" onclick="if(event.target.id === 'bulkStudentModal') closeBulkStudentModal()">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Tambah Siswa Massal</h3>
        <span class="material-icons close-btn" onclick="closeBulkStudentModal()">close</span>
      </div>
      <div class="bulk-input-area">
        <p class="bulk-input-help">Masukkan data siswa dengan format **Nama | NIS | NISN | L/P**. Pisahkan setiap siswa dengan baris baru.</p>
        <p class="bulk-input-help">Contoh:</p>
        <pre class="bulk-example">Budi Santoso | 12345 | 9988776655 | L
Siti Aminah | 12346 | 9988776656 | P</pre>
        <div class="form-group" style="margin-top: 15px;">
          <textarea id="bulkStudentsData" rows="10" placeholder="Masukkan data siswa di sini..." required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-warning" onclick="closeBulkStudentModal()">Batal</button>
        <button class="btn btn-primary" onclick="saveBulkStudents()">Tambah Siswa</button>
      </div>
    </div>
  </div>

  <script>
    /* ------------------------------------- */
    /* JAVASCRIPT LOGIC (Client-side) */
    /* ------------------------------------- */

    let students = [];
    let currentTab = 'students';
    let currentStudentAction = 'add'; // 'add' or 'edit'

    document.addEventListener('DOMContentLoaded', initApp);

    function initApp() {
      // Load initial data
      loadSettings();
      loadStudents();

      // Setup initial view
      showTab('students');
    }

    /* --- Utilities --- */

    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    function showAlert(message, type = 'success', duration = 3000) {
      const alertContainer = document.getElementById('alertContainer');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;

      alertContainer.appendChild(alertDiv);

      setTimeout(() => {
        alertDiv.remove();
      }, duration);
    }

    function showTab(tabName) {
      // Hide all contents
      document.querySelectorAll('.content').forEach(el => el.style.display = 'none');
      // Deactivate all nav buttons
      document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));

      // Show selected content
      document.getElementById(`${tabName}Tab`).style.display = 'block';

      // Activate selected nav button
      document.querySelector(`.nav-btn[onclick="showTab('${tabName}')"]`).classList.add('active');

      currentTab = tabName;

      // Ensure data is refreshed when switching tabs
      if (tabName !== 'settings') {
        renderStudentTables();
      }
    }

    function resetForm(tabName) {
      if (tabName === 'settings') {
        loadSettings();
        showAlert('Pengaturan di-reset ke nilai tersimpan.');
      } else {
        loadStudents();
        showAlert('Data berhasil di-refresh.');
      }
    }

    function calculateAverage(type, index) {
      let values = [];
      const avgInput = document.querySelector(`.${type}-avg[data-index="${index}"]`);
      
      if (type === 'formatif') {
        // Collect Formatif scores (F1-F5)
        values = [1, 2, 3, 4, 5].map(i => parseFloat(document.querySelector(`.f${i}[data-index="${index}"]`).value) || 0)
          .filter(v => v > 0); // Only average non-zero (filled) scores
      } else if (type === 'sumatif') {
        // Collect Sumatif scores (S1-S3)
        values = [1, 2, 3].map(i => parseFloat(document.querySelector(`.s${i}[data-index="${index}"]`).value) || 0)
          .filter(v => v > 0); // Only average non-zero (filled) scores
      }

      const average = values.length > 0 ? (values.reduce((sum, val) => sum + val, 0) / values.length).toFixed(1) : '';
      avgInput.value = average;

      // If sumatif average changes, recalculate final grade
      if (type === 'sumatif' && currentTab === 'akhir') {
            calculateFinalGrade(index);
      }
    }

    function calculateFinalGrade(index) {
      const finalInput = document.querySelector(`.final-score[data-index="${index}"]`);
      const raporInput = document.querySelector(`.rapor-score[data-index="${index}"]`);

      // Get latest sumatif average from input field (which is read-only but holds the calculated value)
      const sumatifAvgInput = document.querySelector(`.sumatif-avg[data-index="${index}"]`);
      const sumatifAvg = parseFloat(sumatifAvgInput ? sumatifAvgInput.value : 0) || 0;
      
      const finalScore = parseFloat(finalInput.value) || 0;
      
      // Calculation: 60% Sumatif Avg + 40% Nilai Akhir
      const nilaiRapor = (sumatifAvg * 0.6) + (finalScore * 0.4);

      raporInput.value = nilaiRapor.toFixed(1);
    }

    /* --- Student Management --- */

    function loadStudents() {
      showLoading();
      google.script.run
        .withSuccessHandler(data => {
          students = data;
          renderStudentTables();
          hideLoading();
        })
        .withFailureHandler(error => {
          showAlert(error, 'error');
          hideLoading();
        })
        .getAllStudentData();
    }

    function renderStudentTables() {
      // Check if students data is available
      if (!students || students.length === 0) {
        const noDataRow = '<tr><td colspan="X" style="text-align: center;">Tidak ada data siswa.</td></tr>';
        document.getElementById('studentsTable').querySelector('tbody').innerHTML = noDataRow.replace('X', 6);
        document.getElementById('formatifTable').querySelector('tbody').innerHTML = noDataRow.replace('X', 8);
        document.getElementById('sumatifTable').querySelector('tbody').innerHTML = noDataRow.replace('X', 6);
        document.getElementById('akhirTable').querySelector('tbody').innerHTML = noDataRow.replace('X', 5);
        return;
      }

      // 1. Students Table (CRUD)
      const studentsTableBody = students.map(student => `
        <tr>
          <td>${student.no}</td>
          <td class="nama">${student.nama}</td>
          <td>${student.nis || '-'}</td>
          <td>${student.nisn || '-'}</td>
          <td>${student.jk || '-'}</td>
          <td>
            <button class="btn btn-warning" style="padding: 5px 8px; font-size: 0.8rem;" onclick="showStudentModal('edit', ${student.originalRowIndex})">Edit</button>
            <button class="btn btn-danger" style="padding: 5px 8px; font-size: 0.8rem;" onclick="confirmDeleteStudent(${student.originalRowIndex}, '${student.nama}')">Hapus</button>
          </td>
        </tr>
      `).join('');
      document.getElementById('studentsTable').querySelector('tbody').innerHTML = studentsTableBody;

      // 2. Formatif Table (Grade Input)
      const formatifTableBody = students.map((student, index) => `
        <tr>
          <td>${student.no}</td>
          <td class="nama">${student.nama}</td>
          <td><input type="number" min="0" max="100" class="f1" data-index="${index}" value="${student.formatif.f1 || ''}" oninput="calculateAverage('formatif', ${index})"></td>
          <td><input type="number" min="0" max="100" class="f2" data-index="${index}" value="${student.formatif.f2 || ''}" oninput="calculateAverage('formatif', ${index})"></td>
          <td><input type="number" min="0" max="100" class="f3" data-index="${index}" value="${student.formatif.f3 || ''}" oninput="calculateAverage('formatif', ${index})"></td>
          <td><input type="number" min="0" max="100" class="f4" data-index="${index}" value="${student.formatif.f4 || ''}" oninput="calculateAverage('formatif', ${index})"></td>
          <td><input type="number" min="0" max="100" class="f5" data-index="${index}" value="${student.formatif.f5 || ''}" oninput="calculateAverage('formatif', ${index})"></td>
          <td><input type="text" class="formatif-avg" data-index="${index}" value="${student.formatif.rataRata ? parseFloat(student.formatif.rataRata).toFixed(1) : ''}" readonly></td>
        </tr>
      `).join('');
      document.getElementById('formatifTable').querySelector('tbody').innerHTML = formatifTableBody;

      // 3. Sumatif Table (Grade Input)
      const sumatifTableBody = students.map((student, index) => `
        <tr>
          <td>${student.no}</td>
          <td class="nama">${student.nama}</td>
          <td><input type="number" min="0" max="100" class="s1" data-index="${index}" value="${student.sumatif.s1 || ''}" oninput="calculateAverage('sumatif', ${index})"></td>
          <td><input type="number" min="0" max="100" class="s2" data-index="${index}" value="${student.sumatif.s2 || ''}" oninput="calculateAverage('sumatif', ${index})"></td>
          <td><input type="number" min="0" max="100" class="s3" data-index="${index}" value="${student.sumatif.s3 || ''}" oninput="calculateAverage('sumatif', ${index})"></td>
          <td><input type="text" class="sumatif-avg" data-index="${index}" value="${student.sumatif.rataRata ? parseFloat(student.sumatif.rataRata).toFixed(1) : ''}" readonly></td>
        </tr>
      `).join('');
      document.getElementById('sumatifTable').querySelector('tbody').innerHTML = sumatifTableBody;

      // 4. Akhir Table (Final Grade Input & Rapor Calculation)
      const akhirTableBody = students.map((student, index) => `
        <tr>
          <td>${student.no}</td>
          <td class="nama">${student.nama}</td>
          <td><input type="text" class="sumatif-avg" data-index="${index}" value="${student.sumatif.rataRata ? parseFloat(student.sumatif.rataRata).toFixed(1) : ''}" readonly></td>
          <td><input type="number" min="0" max="100" class="final-score" data-index="${index}" value="${student.akhirSemester || ''}" oninput="calculateFinalGrade(${index})"></td>
          <td><input type="text" class="rapor-score" data-index="${index}" value="${student.nilaiRapor ? parseFloat(student.nilaiRapor).toFixed(1) : ''}" readonly></td>
        </tr>
      `).join('');
      document.getElementById('akhirTable').querySelector('tbody').innerHTML = akhirTableBody;
    }

    function showStudentModal(action, rowIndex = null) {
      currentStudentAction = action;
      const modal = document.getElementById('studentModal');
      const form = document.getElementById('studentForm');
      form.reset();
      document.getElementById('studentRowIndex').value = '';

      if (action === 'add') {
        document.getElementById('studentModalTitle').textContent = 'Tambah Siswa Baru';
      } else if (action === 'edit' && rowIndex !== null) {
        document.getElementById('studentModalTitle').textContent = 'Edit Data Siswa';
        // Find student based on their original row index in the sheet
        const studentToEdit = students.find(s => s.originalRowIndex === rowIndex);
        if (studentToEdit) {
          document.getElementById('studentRowIndex').value = rowIndex;
          document.getElementById('studentName').value = studentToEdit.nama;
          document.getElementById('studentNIS').value = studentToEdit.nis;
          document.getElementById('studentNISN').value = studentToEdit.nisn;
          document.getElementById('studentGender').value = studentToEdit.jk;
        }
      }
      modal.style.display = 'flex';
    }

    function closeStudentModal() {
      document.getElementById('studentModal').style.display = 'none';
      document.getElementById('studentForm').reset();
    }

    function saveStudent() {
      const form = document.getElementById('studentForm');
      if (!form.reportValidity()) return;

      const studentData = {
        nama: document.getElementById('studentName').value,
        nis: document.getElementById('studentNIS').value,
        nisn: document.getElementById('studentNISN').value,
        jk: document.getElementById('studentGender').value,
        rowIndex: document.getElementById('studentRowIndex').value // Only used for edit (originalRowIndex)
      };

      showLoading();
      
      let gasFunction = currentStudentAction === 'add' ? 'addNewStudent' : 'updateStudentData';

      google.script.run
          .withSuccessHandler(response => {
            if (response.success) {
              showAlert(response.message);
              closeStudentModal();
              loadStudents();
            } else {
              showAlert(response.message, 'error', 5000);
              hideLoading();
            }
          })
          .withFailureHandler(error => {
            showAlert(error, 'error', 5000);
            hideLoading();
          })
          [gasFunction](studentData);
    }

    function confirmDeleteStudent(rowIndex, name) {
      if (confirm(`Anda yakin ingin menghapus data siswa ${name}? Tindakan ini tidak dapat dibatalkan.`)) {
        deleteStudent(rowIndex);
      }
    }

    function deleteStudent(rowIndex) {
      showLoading();
      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            showAlert(response.message, 'danger');
            loadStudents();
          } else {
            showAlert(response.message, 'error');
            hideLoading();
          }
        })
        .withFailureHandler(error => {
          showAlert(error, 'error');
          hideLoading();
        })
        .deleteStudent(rowIndex);
    }
    
    /* --- Bulk Student Management --- */

    function showBulkStudentModal() {
      document.getElementById('bulkStudentModal').style.display = 'flex';
    }

    function closeBulkStudentModal() {
      document.getElementById('bulkStudentModal').style.display = 'none';
      document.getElementById('bulkStudentsData').value = '';
    }

    function saveBulkStudents() {
      const dataText = document.getElementById('bulkStudentsData').value.trim();
      if (!dataText) {
        showAlert('Data siswa massal tidak boleh kosong!', 'error');
        return;
      }

      const lines = dataText.split('\n').filter(line => line.trim() !== '');
      const studentsData = [];
      const errors = [];

      lines.forEach((line, index) => {
        const parts = line.split('|').map(part => part.trim());

        if (parts.length !== 4) {
          errors.push(`Baris ${index + 1}: Format tidak sesuai (harus 4 kolom dipisah dengan |)`);
          return;
        }

        const [nama, nis, nisn, jk] = parts;

        if (!nama || !nis || !nisn || !jk) {
          errors.push(`Baris ${index + 1}: Ada kolom yang kosong`);
          return;
        }
        
        if (jk.toUpperCase() !== 'L' && jk.toUpperCase() !== 'P') {
            errors.push(`Baris ${index + 1}: Jenis Kelamin harus 'L' atau 'P'`);
            return;
        }

        studentsData.push({ nama, nis, nisn, jk: jk.toUpperCase() });
      });

      if (errors.length > 0) {
        showAlert('Validasi Gagal:\n' + errors.slice(0, 5).join('\n') + (errors.length > 5 ? `\ndan ${errors.length - 5} kesalahan lainnya...` : ''), 'error', 10000);
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            showAlert(response.message);
            closeBulkStudentModal();
            loadStudents();
          } else {
            showAlert(response.message, 'error', 5000);
          }
          hideLoading();
        })
        .withFailureHandler(error => {
          showAlert(error, 'error', 5000);
          hideLoading();
        })
        .addMultipleStudents(studentsData);
    }


    /* --- Grade Management --- */

    function saveGrades(type) {
      // 1. Collect data
      const gradeData = students.map((student, index) => {
        const studentData = {
          nama: student.nama, // for reference
          formatif: {},
          sumatif: {},
          akhirSemester: 0
        };

        if (type === 'formatif') {
          studentData.formatif.f1 = document.querySelector(`.f1[data-index="${index}"]`).value;
          studentData.formatif.f2 = document.querySelector(`.f2[data-index="${index}"]`).value;
          studentData.formatif.f3 = document.querySelector(`.f3[data-index="${index}"]`).value;
          studentData.formatif.f4 = document.querySelector(`.f4[data-index="${index}"]`).value;
          studentData.formatif.f5 = document.querySelector(`.f5[data-index="${index}"]`).value;
        } else if (type === 'sumatif') {
          studentData.sumatif.s1 = document.querySelector(`.s1[data-index="${index}"]`).value;
          studentData.sumatif.s2 = document.querySelector(`.s2[data-index="${index}"]`).value;
          studentData.sumatif.s3 = document.querySelector(`.s3[data-index="${index}"]`).value;
        } else if (type === 'akhir') {
          studentData.akhirSemester = document.querySelector(`.final-score[data-index="${index}"]`).value;
        }
        return studentData;
      });

      // 2. Determine GAS function
      let gasFunction;
      if (type === 'formatif') gasFunction = 'saveFormatifData';
      else if (type === 'sumatif') gasFunction = 'saveSumatifData';
      else if (type === 'akhir') gasFunction = 'saveAkhirSemesterData';
      else return;

      // 3. Run script
      showLoading();
      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            showAlert(response.message);
            loadStudents(); // Reload all data to see updated averages/rapor
          } else {
            showAlert(response.message, 'error');
            hideLoading();
          }
        })
        .withFailureHandler(error => {
          showAlert(error, 'error');
          hideLoading();
        })
        [gasFunction](gradeData);
    }
    
    function confirmResetAllGrades() {
        if (confirm("PERINGATAN! Tindakan ini akan menghapus SEMUA data nilai (Formatif, Sumatif, Akhir, Rapor) untuk semua siswa. Data siswa TIDAK akan terhapus. Lanjutkan?")) {
            resetAllGrades();
        }
    }
    
    function resetAllGrades() {
        showLoading();
        google.script.run
            .withSuccessHandler(response => {
                if (response.success) {
                    showAlert(response.message, 'danger');
                    loadStudents();
                } else {
                    showAlert(response.message, 'error');
                    hideLoading();
                }
            })
            .withFailureHandler(error => {
                showAlert(error, 'error');
                hideLoading();
            })
            .resetAllGrades();
    }


    /* --- Settings Management --- */

    function loadSettings() {
      google.script.run
        .withSuccessHandler(settings => {
          document.getElementById('className').value = settings.className;
          document.getElementById('subjectName').value = settings.subjectName;
          document.getElementById('schoolName').value = settings.schoolName;
          document.getElementById('teacherName').value = settings.teacherName;
          document.getElementById('semester').value = settings.semester;
          document.getElementById('academicYear').value = settings.academicYear;

          // Update header
          document.getElementById('headerTitle').textContent = `Sistem Daftar Nilai - ${settings.subjectName}`;
          document.getElementById('headerSubtitle').textContent = `${settings.className}, ${settings.semester} ${settings.academicYear}`;
        })
        .withFailureHandler(error => {
          showAlert(`Gagal memuat pengaturan: ${error}`, 'error');
        })
        .getClassAndSubject();
    }

    function saveSettings() {
      const settings = {
        className: document.getElementById('className').value.trim(),
        subjectName: document.getElementById('subjectName').value.trim(),
        schoolName: document.getElementById('schoolName').value.trim(),
        teacherName: document.getElementById('teacherName').value.trim(),
        semester: document.getElementById('semester').value,
        academicYear: document.getElementById('academicYear').value.trim()
      };

      if (!settings.className || !settings.subjectName || !settings.schoolName || !settings.semester || !settings.academicYear) {
        showAlert('Field yang wajib harus diisi!', 'error');
        return;
      }

      showLoading();

      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            showAlert(response.message);
            loadSettings(); // Reload settings to update header
            loadStudents(); // Reload students to refresh view
          } else {
            showAlert(response.message, 'error');
          }
          hideLoading();
        })
        .withFailureHandler(error => {
          showAlert(error, 'error');
          hideLoading();
        })
        .updateSettings(settings);
    }
    
    /* --- Print/Download --- */

    function printPreview() {
      if (students.length === 0) {
        showAlert('Belum ada data siswa!', 'error');
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(html => {
          hideLoading();
          const newWindow = window.open('', '_blank');
          newWindow.document.write(html);
          newWindow.document.close();
        })
        .withFailureHandler(error => {
          showAlert(error, 'error');
          hideLoading();
        })
        .getPreviewHTML();
    }

    function downloadExcel() {
      if (students.length === 0) {
        showAlert('Belum ada data siswa!', 'error');
        return;
      }

      showLoading();

      google.script.run
        .withSuccessHandler(response => {
          hideLoading();
          // Use base64 content to trigger file download on client-side
          const link = document.createElement('a');
          link.href = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,' + response.content;
          link.download = response.fileName;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          showAlert('File Excel berhasil di-download!');
        })
        .withFailureHandler(error => {
          showAlert(error, 'error');
          hideLoading();
        })
        .downloadExcel();
    }
  </script>
</body>

</html>
             